name: Release (Debian Trixie)

on:
  push:
    tags:
      - 'v*'   # e.g. v0.1.2

jobs:
  release:
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
      options: --init

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Install build toolchain
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential pkg-config \
            libfuse3-dev fuse3 \
            rustc cargo rustfmt rust-clippy clang \
            devscripts debhelper dh-cargo lintian

      - name: Set version from tag in debian/changelog
        env:
          TAG: ${{ github.ref_name }}   # e.g. v0.1.2
        run: |
          set -e
          VERSION="${TAG#v}"
          echo "Building version $VERSION"
          dch --changelog debian/changelog \
              -v "${VERSION}-1" \
              --distribution trixie \
              "Release ${VERSION}" || true
          dch -r "" || true

          # sanity check: ensure dpkg version matches the tag
          dpkg-parsechangelog -S Version | grep -E "^${VERSION}-"

      - name: Build (fmt + clippy + release)
        run: |
          cargo fmt -- --check
          cargo clippy -- -D warnings
          cargo build --release

      - name: Build .deb (debuild)
        run: debuild -us -uc -b

      - name: Lintian (non-fatal)
        run: |
          lintian ../chd2iso-fuse_*_amd64.changes || true

      - name: Gather artifacts
        run: |
          mkdir -p artifacts
          mv ../chd2iso-fuse_*_amd64.deb artifacts/
          mv ../chd2iso-fuse-dbgsym_*_amd64.deb artifacts/ || true
          mv ../chd2iso-fuse_*_amd64.buildinfo artifacts/
          mv ../chd2iso-fuse_*_amd64.changes artifacts/
          ls -l artifacts

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: chd2iso-fuse ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            artifacts/*.deb
            artifacts/*.buildinfo
            artifacts/*.changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
