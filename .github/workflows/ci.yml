name: Build & (on tag) Release – Debian Trixie

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'     # e.g. v0.1.4
  pull_request:

# Needed to create releases
permissions:
  contents: write
  actions: read

jobs:
  build-debs:
    name: Build .deb (always)
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
      options: --init
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Install toolchain & build deps
        run: |
          set -e
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential pkg-config \
            libfuse3-dev fuse3 \
            rustc cargo rustfmt rust-clippy clang \
            devscripts debhelper dh-cargo lintian \
            curl jq ca-certificates git

      # Cache cargo registry & target to speed up builds
      - name: Cache cargo registry & target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Build a Debian changelog entry + Markdown release notes (only on tags)
      - name: Generate Debian changelog from Git + merged PRs (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TAG: ${{ github.ref_name }}          # e.g. v0.1.4
          REPO: ${{ github.repository }}       # owner/name
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          VERSION="${TAG#v}"
          git fetch --tags --force --prune

          # Work out range between previous tag and this tag
          mapfile -t TAGS < <(git tag --list --sort=creatordate)
          PREV_TAG=""
          for i in "${!TAGS[@]}"; do
            if [[ "${TAGS[$i]}" == "${TAG}" ]]; then
              if (( i > 0 )); then PREV_TAG="${TAGS[$((i-1))]}"; fi
              break
            fi
          done

          if [[ -n "${PREV_TAG}" ]]; then
            RANGE="${PREV_TAG}..${TAG}"
          else
            FIRST_COMMIT="$(git rev-list --max-parents=0 "${TAG}")"
            RANGE="${FIRST_COMMIT}..${TAG}"
          fi

          # Collect commits (no merges)
          mapfile -t CHANGES < <(git log --no-merges --reverse --pretty=format:'- %s (%h)' "${RANGE}" || true)

          # Collect merged PRs via GitHub API between prev and current tag dates
          START_ISO="1970-01-01T00:00:00Z"
          if [[ -n "${PREV_TAG}" ]]; then
            START_ISO="$(git log -1 --format=%cI "${PREV_TAG}")"
          fi
          END_ISO="$(git log -1 --format=%cI "${TAG}")"

          PRS_JSON="$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/issues?q=repo:${REPO}+is:pr+is:merged+merged:${START_ISO}..${END_ISO}&per_page=100")"

          mapfile -t PR_LINES < <(echo "${PRS_JSON}" \
            | jq -r '.items[] | "- PR #\(.number): \(.title) (@\(.user.login))"' || true)

          # Start a new Debian changelog entry
          dch --changelog debian/changelog \
              -v "${VERSION}-1" \
              --distribution trixie \
              --urgency medium \
              "Release ${VERSION}"

          if ((${#CHANGES[@]})); then
            for line in "${CHANGES[@]}"; do
              dch --changelog debian/changelog -a "$line"
            done
          else
            dch --changelog debian/changelog -a "No direct commit changes since ${PREV_TAG:-initial}."
          fi

          if ((${#PR_LINES[@]})); then
            dch --changelog debian/changelog -a ""
            dch --changelog debian/changelog -a "Merged PRs:"
            for pr in "${PR_LINES[@]}"; do
              dch --changelog debian/changelog -a "  ${pr}"
            done
          else
            dch --changelog debian/changelog -a ""
            dch --changelog debian/changelog -a "Merged PRs: (none in this window)"
          fi

          # Close the entry
          dch --changelog debian/changelog -r ""

          # Emit Markdown release body from *latest* changelog stanza
          mkdir -p artifacts
          VER=$(dpkg-parsechangelog -l debian/changelog -S Version)
          DATE=$(dpkg-parsechangelog -l debian/changelog -S Date || true)
          CHG=$(dpkg-parsechangelog -l debian/changelog -S Changes | sed 's/^[ ]*//')

          {
            echo "# chd2iso-fuse ${VER}"
            [[ -n "$DATE" ]] && echo "_${DATE}_"
            echo
            echo "${CHG}"
          } > artifacts/RELEASE_NOTES.md

      - name: Cargo fmt + clippy + build
        run: |
          cargo fmt -- --check
          cargo clippy -- -D warnings
          cargo build --release

      - name: Build .deb with debuild
        run: debuild -us -uc -b

      - name: Lintian (non-fatal)
        run: lintian ../chd2iso-fuse_*_amd64.changes || true

      - name: Collect artifacts
        run: |
          set -e
          mkdir -p artifacts
          mv ../chd2iso-fuse_*_amd64.deb artifacts/ || true
          mv ../chd2iso-fuse-dbgsym_*_amd64.deb artifacts/ || true
          mv ../chd2iso-fuse_*_amd64.buildinfo artifacts/ || true
          mv ../chd2iso-fuse_*_amd64.changes artifacts/ || true
          # ensure release notes file exists even on non-tag pushes
          test -f artifacts/RELEASE_NOTES.md || echo "(build from branch/PR – no tagged release notes)" > artifacts/RELEASE_NOTES.md
          ls -l artifacts || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chd2iso-fuse-debs
          path: artifacts/*
          if-no-files-found: error
          retention-days: 14

  publish-release:
    name: Publish GitHub Release (only on tag)
    runs-on: ubuntu-latest
    needs: build-debs
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: chd2iso-fuse-debs
          path: artifacts

      - name: Create/Update Release & attach artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: chd2iso-fuse ${{ github.ref_name }}
          body_path: artifacts/RELEASE_NOTES.md
          generate_release_notes: false
          files: |
            artifacts/*.deb
            artifacts/*.buildinfo
            artifacts/*.changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
