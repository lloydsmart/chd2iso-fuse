name: Build & (on tag) Release – Debian Trixie

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'     # e.g. v0.1.4
  pull_request:

# Needed to create releases and open PRs
permissions:
  contents: write
  actions: read
  pull-requests: write

# Ensure every `run:` executes from the repo root
defaults:
  run:
    working-directory: ${{ github.workspace }}

jobs:
  build-debs:
    name: Build .deb (always)
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
      options: --init
    env:
      # Pin git-cliff to a version compatible with Debian's rustc (1.85.0)
      GIT_CLIFF_VERSION: "2.9.1"
      # Speed up Rust builds with sccache
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.sccache
      SCCACHE_CACHE_SIZE: 2G
      # Stabilize debug info paths to improve cache hits
      RUSTFLAGS: "--remap-path-prefix=${{ github.workspace }}=."

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          fetch-tags: true

      # Single apt step (adds sccache too)
      - name: Install build deps (one shot)
        run: |
          set -e
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential pkg-config \
            libfuse3-dev fuse3 \
            rustc cargo rustfmt rust-clippy clang \
            devscripts debhelper dh-cargo lintian \
            git-buildpackage \
            sccache \
            curl jq ca-certificates git

      - name: Add ~/.cargo/bin to PATH
        run: echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      # Detect rustc version for smarter cache keys
      - name: Detect rustc version
        id: rustver
        run: |
          echo "ver=$(rustc -V | awk '{print $2}')" >> "$GITHUB_OUTPUT"

      - name: Show rustc version
        run: |
          echo "Detected rustc version: ${{ steps.rustver.outputs.ver }}"

      # Compute a stable key component even if there’s no Cargo.lock
      - name: Compute Cargo.lock hash (safe)
        id: cargo_lock_hash
        run: |
          set -e
          if find . -name Cargo.lock -type f | grep -q .; then
            sha=$(find . -name Cargo.lock -type f -print0 | sort -z | xargs -0 cat | sha256sum | cut -d' ' -f1)
            echo "hash=$sha" >> "$GITHUB_OUTPUT"
          else
            echo "hash=none" >> "$GITHUB_OUTPUT"
          fi

      # Stable SOURCE_DATE_EPOCH (commit timestamp) for reproducible builds & cache hits
      - name: Compute SOURCE_DATE_EPOCH from HEAD
        id: sde
        run: |
          echo "epoch=$(git log -1 --format=%ct)" >> "$GITHUB_OUTPUT"

      # Ensure sccache dir exists & show it (handy for debugging cache hits)
      - name: Ensure sccache dir exists and show path
        run: |
          mkdir -p "${SCCACHE_DIR}"
          echo "SCCACHE_DIR=${SCCACHE_DIR}"

      # Cache sccache first so cargo can use it immediately
      - name: Cache sccache store
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: sccache-${{ runner.os }}-${{ steps.cargo_lock_hash.outputs.hash }}-rust-${{ steps.rustver.outputs.ver }}
          restore-keys: |
            sccache-${{ runner.os }}-

      # Cache cargo registry & target (key includes rust version + Cargo.lock hash)
      - name: Cache cargo registry & target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ steps.cargo_lock_hash.outputs.hash }}-rust-${{ steps.rustver.outputs.ver }}
          restore-keys: |
            cargo-${{ runner.os }}-

      # Avoid recompiling git-cliff on every run
      - name: Cache git-cliff binary
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/git-cliff
          key: git-cliff-bin-${{ runner.os }}-${{ env.GIT_CLIFF_VERSION }}

      - name: Install git-cliff (pinned)
        run: |
          if ! command -v git-cliff >/dev/null 2>&1; then
            cargo install git-cliff --locked --version "${GIT_CLIFF_VERSION}"
          fi

      - name: Ensure helper scripts are executable
        run: |
          chmod +x scripts/gen-debian-changelog.sh
          chmod +x scripts/gen-release-notes.sh

      # Optional: clear prior sccache counters for cleaner stats
      - name: sccache zero-stats
        run: sccache --zero-stats || true

      # === Only on tags: generate Debian changelog via gbp dch ===
      - name: Generate Debian changelog (gbp dch)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TAG: ${{ github.ref_name }}
        working-directory: ${{ github.workspace }}
        run: scripts/gen-debian-changelog.sh "$TAG" trixie

      # === Only on tags: generate Markdown changelog + release notes via git-cliff ===
      - name: Generate CHANGELOG.md + RELEASE_NOTES.md (git-cliff)
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: ${{ github.workspace }}
        run: scripts/gen-release-notes.sh artifacts

      # === Only on tags: open a PR to update CHANGELOG.md on main ===
      - name: Prepare CHANGELOG update (copy into repo)
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: ${{ github.workspace }}
        run: cp artifacts/CHANGELOG.md CHANGELOG.md

      - name: Create PR to update CHANGELOG.md on main
        if: startsWith(github.ref, 'refs/tags/')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: chore/update-changelog-${{ github.ref_name }}
          title: "docs(changelog): update for ${{ github.ref_name }}"
          body: |
            Automated PR to update CHANGELOG.md for ${{ github.ref_name }}.
            Generated by git-cliff during the tagged build.
          commit-message: "docs(changelog): update for ${{ github.ref_name }}"
          add-paths: |
            CHANGELOG.md
          delete-branch: true
          labels: |
            automated
            changelog

      # Enforce a committed lockfile so CI never re-resolves deps
      - name: Verify Cargo.lock is present
        run: |
          test -f Cargo.lock || { echo "ERROR: Cargo.lock missing. Commit it to the repo."; exit 1; }

      # Prefetch deps strictly from lockfile (no network during later steps)
      - name: cargo fetch (locked)
        run: cargo fetch --locked

      # Lint without network and fail on warnings (no extra release build here)
      - name: Cargo fmt + clippy
        env:
          SOURCE_DATE_EPOCH: ${{ steps.sde.outputs.epoch }}
        run: |
          cargo fmt -- --check
          cargo clippy --all-targets --frozen -- -D warnings

      - name: Build .deb with debuild
        env:
          # Ensure dh-cargo builds also benefit from sccache and stable timestamps
          RUSTC_WRAPPER: ${{ env.RUSTC_WRAPPER }}
          SCCACHE_DIR: ${{ env.SCCACHE_DIR }}
          SOURCE_DATE_EPOCH: ${{ steps.sde.outputs.epoch }}
        run: debuild -us -uc -b

      # Optional: show sccache hit/miss ratio after all builds (cargo + dh-cargo)
      - name: sccache stats
        run: sccache --show-stats || true

      - name: Lintian (non-fatal)
        run: lintian ../chd2iso-fuse_*_amd64.changes || true

      - name: Collect artifacts
        run: |
          set -e
          mkdir -p artifacts
          mv ../chd2iso-fuse_*_amd64.deb artifacts/ || true
          mv ../chd2iso-fuse-dbgsym_*_amd64.deb artifacts/ || true
          mv ../chd2iso-fuse_*_amd64.buildinfo artifacts/ || true
          mv ../chd2iso-fuse_*_amd64.changes artifacts/ || true
          # Ensure release notes exist for non-tag pushes (placeholder)
          test -f artifacts/RELEASE_NOTES.md || echo "(build from branch/PR – no tagged release notes)" > artifacts/RELEASE_NOTES.md
          ls -l artifacts || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chd2iso-fuse-debs
          path: artifacts/*
          if-no-files-found: error
          retention-days: 14

  publish-release:
    name: Publish GitHub Release (only on tag)
    runs-on: ubuntu-latest
    needs: build-debs
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: chd2iso-fuse-debs
          path: artifacts

      - name: Create/Update Release & attach artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: chd2iso-fuse ${{ github.ref_name }}
          body_path: artifacts/RELEASE_NOTES.md   # generated by git-cliff on tags
          generate_release_notes: false
          files: |
            artifacts/CHANGELOG.md
            artifacts/*.deb
            artifacts/*.buildinfo
            artifacts/*.changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
