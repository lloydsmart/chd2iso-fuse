name: Reusable — Tick a checkbox on the release PR ☑️

on:
  workflow_call:
    inputs:
      branch:
        description: "Release/Hotfix branch name (e.g., release/1.2.3)"
        type: string
        required: true
      box:
        description: "Which box to tick: ci | bump | codeql"
        type: string
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  tick:
    runs-on: ubuntu-latest
    steps:
      - name: 📝 Update PR body checkbox
        id: update
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchRaw = core.getInput('branch') || '';
            const whichRaw  = core.getInput('box') || '';
            const branch = branchRaw.trim();
            const which0 = whichRaw.trim().toLowerCase();

            // accept a few synonyms just in case
            const alias = {
              'ci': 'ci',
              'build': 'ci',
              'tests': 'ci',
              'bump': 'bump',
              'version': 'bump',
              'changelog': 'bump',
              'codeql': 'codeql',
              'security': 'codeql',
              'scan': 'codeql',
            };
            const which = alias[which0];

            if (!branch) {
              core.setFailed('Missing required input: branch');
              return;
            }
            if (!which) {
              core.setFailed(`Unknown box: "${whichRaw}". Expected one of: ci | bump | codeql`);
              return;
            }

            // exact lines expected in the PR template
            const mapping = {
              ci:     /^- \[ \] CI build & tests passed$/m,
              bump:   /^- \[ \] Version bump & changelog completed$/m,
              codeql: /^- \[ \] CodeQL security scan completed$/m,
            };
            const doneMapping = {
              ci:     '- [x] CI build & tests passed',
              bump:   '- [x] Version bump & changelog completed',
              codeql: '- [x] CodeQL security scan completed',
            };

            // Find the open PR from this branch -> main
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`,
              base: 'main'
            });
            const pr = prs[0];
            if (!pr) {
              core.setFailed(`No open PR from ${branch} to main`);
              return;
            }

            let body = pr.body || '';

            // If already ticked, nothing to do
            if (body.includes(doneMapping[which])) {
              core.info(`Box "${which}" already ticked for PR #${pr.number}`);
            } else {
              // Try replacing the unchecked line with the checked one
              const replaced = body.replace(mapping[which], doneMapping[which]);
              body = replaced;

              // If the expected unchecked line is missing (manual edits), append a checked line as a safeguard
              if (!body.includes(doneMapping[which])) {
                body += `\n${doneMapping[which]}`;
              }

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body
              });
              core.info(`Ticked "${which}" for PR #${pr.number}`);
            }

            // If ALL three are checked, flip draft -> Ready for review
            const allChecked =
              body.includes(doneMapping.ci) &&
              body.includes(doneMapping.bump) &&
              body.includes(doneMapping.codeql);

            if (allChecked && pr.draft) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                draft: false
              });
              core.info(`All boxes checked. PR #${pr.number} is now Ready for review.`);
            } else {
              core.info(`All checked? ${allChecked}. Draft? ${pr.draft}`);
            }
