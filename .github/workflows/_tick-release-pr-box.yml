name: Reusable — Tick a checkbox on the release PR ☑️

on:
  workflow_call:
    inputs:
      branch:
        description: "Release/Hotfix branch name (e.g., release/1.2.3)"
        type: string
        required: true
      box:
        description: "Which box to tick: ci | bump | codeql"
        type: string
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  tick:
    runs-on: ubuntu-latest
    steps:
      - name: 📝 Update PR body checkbox
        id: update
        uses: actions/github-script@v7
        with:
          script: |
            const branch = core.getInput('branch');
            const which = core.getInput('box'); // ci | bump | codeql

            const mapping = {
              ci:     /^- \\[ \\] CI build & tests passed$/m,
              bump:   /^- \\[ \\] Version bump & changelog completed$/m,
              codeql: /^- \\[ \\] CodeQL security scan completed$/m,
            };

            const doneMapping = {
              ci:     '- [x] CI build & tests passed',
              bump:   '- [x] Version bump & changelog completed',
              codeql: '- [x] CodeQL security scan completed',
            };

            if (!mapping[which]) {
              core.setFailed(`Unknown box: ${which}`);
              return;
            }

            // Find the open PR to main for this branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`,
              base: 'main'
            });
            const pr = prs[0];
            if (!pr) {
              core.setFailed(`No open PR from ${branch} to main`);
              return;
            }

            let body = pr.body || '';

            // If already ticked, nothing to do
            if (body.includes(doneMapping[which])) {
              core.info(`Box "${which}" already ticked for PR #${pr.number}`);
            } else {
              // Replace unchecked line with checked
              const replaced = body.replace(mapping[which], doneMapping[which]);
              body = replaced;

              // Idempotency: if template line went missing, append safeguard
              if (!body.includes(doneMapping[which])) {
                body += `\n${doneMapping[which]}`;
              }

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body
              });
              core.info(`Ticked "${which}" for PR #${pr.number}`);
            }

            // If ALL three are checked, flip draft -> ready for review
            const allChecked =
              body.includes(doneMapping.ci) &&
              body.includes(doneMapping.bump) &&
              body.includes(doneMapping.codeql);

            if (allChecked && pr.draft) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                draft: false
              });
              core.info(`All boxes checked. PR #${pr.number} is now Ready for review.`);
            } else {
              core.info(`All checked? ${allChecked}. Draft? ${pr.draft}`);
            }
