name: Security audit (cargo-audit)

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]
  schedule:
    - cron: "45 3 * * 1"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: sec-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cargo-audit:
    name: cargo-audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      ACCEPTED: ${{ vars.RUSTSEC_ACCEPTED_ADVISORIES || secrets.RUSTSEC_ACCEPTED_ADVISORIES || '' }}
      CARGO_TERM_COLOR: always

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      # Cache the cargo-audit binary; key includes the resolved version so upgrades invalidate cache
      - name: Cache cargo-audit binary
        id: cache_audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-bin-${{ runner.os }}-latest

      - name: Install latest cargo-audit
        run: |
          set -euo pipefail
          if ! command -v cargo-audit >/dev/null 2>&1; then
            cargo install cargo-audit --locked
          fi
          cargo -V
          rustc -V
          cargo audit --version

      # Ensure a lockfile exists (needed by cargo-audit)
      - name: Ensure Cargo.lock exists
        run: |
          set -euo pipefail
          if [ ! -f Cargo.lock ]; then
            echo "Cargo.lock not found; generatingâ€¦"
            cargo generate-lockfile
          fi

      # Run audit (advisory DB auto-updates unless --no-fetch is given)
      - name: Run cargo-audit
        shell: bash
        run: |
          set -euo pipefail
          args=( -D warnings )
          if [[ -n "${ACCEPTED}" ]]; then
            IFS=',' read -ra ids <<< "${ACCEPTED}"
            for id in "${ids[@]}"; do
              id_trimmed="$(echo "$id" | xargs)"
              [[ -n "$id_trimmed" ]] && args+=( --ignore "$id_trimmed" )
            done
          fi
          echo "Running: cargo audit ${args[*]}"
          cargo audit "${args[@]}"
