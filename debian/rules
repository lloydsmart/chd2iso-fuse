#!/usr/bin/make -f
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

%:
	dh $@

override_dh_auto_configure:
	# nothing (use Cargoâ€™s defaults)

override_dh_auto_build:
	cargo build --release --locked

# Ship units but do NOT enable or start them automatically.
override_dh_installsystemd:
	dh_installsystemd --no-enable --no-start chd2iso-fuse@.service
	dh_installsystemd --no-enable --no-start mnt-retronas-roms-sony-playstation2-iso.mount
	dh_installsystemd --no-enable --no-start mnt-retronas-roms-sony-playstation2-iso.automount

override_dh_auto_install:
	# Main binary
	install -D -m 0755 target/release/chd2iso-fuse \
		debian/chd2iso-fuse/usr/bin/chd2iso-fuse

	# Manpage (if present)
	if [ -f debian/chd2iso-fuse.1 ]; then \
	  install -D -m 0644 debian/chd2iso-fuse.1 \
	    debian/chd2iso-fuse/usr/share/man/man1/chd2iso-fuse.1; \
	fi

	# Helpers -> /usr/sbin (not /sbin)
	if [ -f packaging/mount.chd2iso-fuse ]; then \
	  install -D -m 0755 packaging/mount.chd2iso-fuse \
	    debian/chd2iso-fuse/usr/sbin/mount.chd2iso-fuse; \
	fi
	if [ -f packaging/umount.chd2iso-fuse ]; then \
	  install -D -m 0755 packaging/umount.chd2iso-fuse \
	    debian/chd2iso-fuse/usr/sbin/umount.chd2iso-fuse; \
	fi

	# Systemd template unit ONLY -> /usr/lib/systemd/system
	install -D -m 0644 packaging/systemd/chd2iso-fuse@.service \
		debian/chd2iso-fuse/usr/lib/systemd/system/chd2iso-fuse@.service

	# Example units/configs go to /usr/share/doc/.../examples
	install -d debian/chd2iso-fuse/usr/share/doc/chd2iso-fuse/examples/systemd
	if [ -d packaging/systemd ]; then \
	  install -m 0644 packaging/systemd/*.mount \
	    debian/chd2iso-fuse/usr/share/doc/chd2iso-fuse/examples/systemd/ 2>/dev/null || true; \
	  install -m 0644 packaging/systemd/*.automount \
	    debian/chd2iso-fuse/usr/share/doc/chd2iso-fuse/examples/systemd/ 2>/dev/null || true; \
	  install -m 0644 packaging/systemd/ps2.conf.example \
	    debian/chd2iso-fuse/usr/share/doc/chd2iso-fuse/examples/; \
	fi
